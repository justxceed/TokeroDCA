<?xml version="1.0" encoding="utf-8"?>

<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:maui="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    x:Class="TokeroDCA.Views.PortfolioPage">
    <StackLayout Spacing="0">

        <!-- Live Prices Section -->
        <Border
            Stroke="LightGray"
            StrokeThickness="1"
            StrokeShape="RoundRectangle 10,10,10,10"
            BackgroundColor="White"
            Padding="16"
            Margin="10"
            VerticalOptions="Start">
            <Border.Shadow>
                <Shadow Brush="Gray"
                        Offset="4,4"
                        Radius="10"
                        Opacity="0.5" />
            </Border.Shadow>
            <CollectionView ItemsSource="{Binding LivePrices}" SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*" />
                                <ColumnDefinition Width="2*" />
                            </Grid.ColumnDefinitions>
                            <Label
                                Text="{Binding Name}"
                                VerticalOptions="Center"
                                FontAttributes="Bold" />
                            <Label
                                Grid.Column="1"
                                Text="{Binding Latest, StringFormat='€{0:F2}'}"
                                TextColor="{Binding PriceColor}"
                                HorizontalTextAlignment="End"
                                VerticalOptions="Center"
                                IsVisible="{Binding PriceLoaded}" />
                            <Label
                                Grid.Column="1"
                                Text="Fetching live price..."
                                HorizontalTextAlignment="End"
                                VerticalOptions="Center"
                                IsVisible="{Binding PriceLoaded, Converter={toolkit:InvertedBoolConverter}}" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Border>

        <!-- Portfolio Table Section -->
        <Border
            Stroke="LightGray"
            StrokeThickness="1"
            StrokeShape="RoundRectangle 10,10,10,10"
            BackgroundColor="White"
            Margin="10"
            VerticalOptions="FillAndExpand">
            <Border.Shadow>
                <Shadow Brush="Gray"
                        Offset="4,4"
                        Radius="10"
                        Opacity="0.5" />
            </Border.Shadow>
            <ScrollView>
                <CollectionView ItemsSource="{Binding PortfolioRows}" SelectionMode="None">
                    <CollectionView.Header>
                        <Grid
                            Padding="4"
                            ColumnSpacing="10"
                            BackgroundColor="LightGray">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="1.7*" />
                                <ColumnDefinition Width="1.7*" />
                                <ColumnDefinition Width="1.7*" />
                                <ColumnDefinition Width="1.7*" />
                            </Grid.ColumnDefinitions>

                            <Label
                                Text="Date"
                                HorizontalTextAlignment="Center"
                                VerticalOptions="Center"
                                Grid.Column="0" />
                            <Label
                                Text="Invested"
                                HorizontalTextAlignment="Center"
                                VerticalOptions="Center"
                                Grid.Column="1" />
                            <Label
                                Text="Value Today"
                                HorizontalTextAlignment="Center"
                                VerticalOptions="Center"
                                Grid.Column="2" />
                            <Label
                                Text="ROI"
                                HorizontalTextAlignment="Center"
                                VerticalOptions="Center"
                                Grid.Column="3" />
                        </Grid>
                    </CollectionView.Header>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="4" ColumnSpacing="10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="1.7*" />
                                    <ColumnDefinition Width="1.7*" />
                                    <ColumnDefinition Width="1.7*" />
                                    <ColumnDefinition Width="1.7*" />
                                </Grid.ColumnDefinitions>

                                <Label Text="{Binding Date, StringFormat='{0:yyyy-MM-dd}'}"
                                       HorizontalTextAlignment="Center" Grid.Column="0" />
                                <Label Text="{Binding Invested, StringFormat='€{0:F2}'}"
                                       HorizontalTextAlignment="Center"
                                       Grid.Column="1" />
                                <Label Text="{Binding ValueToday, StringFormat='€{0:F2}'}"
                                       HorizontalTextAlignment="Center"
                                       Grid.Column="2" />
                                <Label Text="{Binding ROI, StringFormat='{0:F1}%'}" HorizontalTextAlignment="Center"
                                       Grid.Column="3"
                                       TextColor="{Binding ROI, Converter={StaticResource RoiColorConverter}}" />
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </ScrollView>
        </Border>
        <Border
            Stroke="LightGray"
            StrokeThickness="1"
            StrokeShape="RoundRectangle 10,10,10,10"
            BackgroundColor="White"
            Padding="16,8"
            Margin="10"
            HeightRequest="250">
            <Border.Shadow>
                <Shadow Brush="Gray"
                        Offset="4,4"
                        Radius="10"
                        Opacity="0.5" />
            </Border.Shadow>
            <maui:ChartView
                Chart="{Binding PortfolioChart}"
                VerticalOptions="FillAndExpand"
                HorizontalOptions="FillAndExpand" />
        </Border>
    </StackLayout>
</ContentPage>